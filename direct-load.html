<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <base href="./" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Espanso GUI - Direct Load</title>
  </head>
  <body>
    <div id="app"></div>

    <!-- 确保挂载点存在 -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        if (!document.getElementById('app')) {
          console.warn('找不到 #app 元素，创建一个新的挂载点');
          const appElement = document.createElement('div');
          appElement.id = 'app';
          document.body.appendChild(appElement);
        }
      });
    </script>

    <!-- 直接加载构建后的 JS 文件 -->
    <script>
      // 检测构建后的 JS 文件路径
      window.onload = function() {
        // 尝试加载不同路径的 JS 文件
        const possiblePaths = [
          './dist/assets/index.js',
          './assets/index.js',
          './dist/assets/index-*.js', // 使用通配符匹配哈希文件名
          './assets/index-*.js'
        ];

        // 查找页面上所有脚本标签
        const scripts = document.getElementsByTagName('script');
        console.log('Current scripts:', scripts.length);

        // 创建一个函数来加载 JS 文件
        function loadScript(src) {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.type = 'module';
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
            console.log('Trying to load:', src);
          });
        }

        // 尝试查找构建后的 JS 文件
        async function findAndLoadScript() {
          // 首先尝试使用 fetch 检查文件是否存在
          for (const path of possiblePaths) {
            try {
              // 如果路径包含通配符，尝试列出目录
              if (path.includes('*')) {
                const dirPath = path.substring(0, path.lastIndexOf('/'));
                console.log('Checking directory:', dirPath);

                // 这里我们无法直接列出目录，但可以尝试加载
                const baseFileName = path.split('*')[0];
                const fileExt = path.split('*')[1];

                // 尝试加载目录中的文件
                try {
                  const response = await fetch(dirPath);
                  if (response.ok) {
                    console.log('Directory exists:', dirPath);
                    // 尝试加载目录中的第一个匹配文件
                    const files = await response.text();
                    const regex = new RegExp(`${baseFileName.split('/').pop()}[a-zA-Z0-9-]+${fileExt}`);
                    const match = files.match(regex);

                    if (match) {
                      const fileName = match[0];
                      const fullPath = `${dirPath}/${fileName}`;
                      console.log('Found file:', fullPath);
                      await loadScript(fullPath);
                      return;
                    }
                  }
                } catch (e) {
                  console.error('Error checking directory:', e);
                }
              } else {
                // 直接尝试加载文件
                const response = await fetch(path);
                if (response.ok) {
                  console.log('File exists:', path);
                  await loadScript(path);
                  return;
                }
              }
            } catch (e) {
              console.error('Error checking file:', path, e);
            }
          }

          // 如果所有路径都失败，显示错误消息
          document.body.innerHTML += `
            <div style="padding: 20px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px; margin: 20px;">
              <h3>加载失败</h3>
              <p>无法加载应用程序的主要 JavaScript 文件。</p>
              <p>尝试过的路径:</p>
              <ul>
                ${possiblePaths.map(p => `<li>${p}</li>`).join('')}
              </ul>
            </div>
          `;
        }

        // 执行查找和加载脚本
        findAndLoadScript();
      };
    </script>
  </body>
</html>
