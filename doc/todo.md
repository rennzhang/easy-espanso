# Espanso GUI 项目进度

## 已完成功能

- [x] **任务 1.1: 环境设置与依赖安装**
  - 创建了package.json文件
  - 安装了所有必需的依赖库（vue@next, pinia, @nuxt/ui, @vuelidate/core, @vuelidate/validators, vue-draggable-next, js-yaml, uuid等）
  - 创建了基本的项目结构
  - 验证了Vite开发服务器能成功启动

- [x] **任务 1.2: 项目目录结构创建**
  - 创建了完整的项目目录结构
  - 创建了三栏式布局组件（MainLayout, LeftPane, MiddlePane, RightPane）
  - 创建了表单组件（RuleEditForm, GroupEditForm）
  - 创建了通用组件（TagInput）
  - 创建了服务层接口（fileService）
  - 创建了全局样式

- [x] **任务 1.3: 核心数据模型定义**
  - 完善了数据模型，添加了对Espanso所有功能的支持
  - 添加了变量、表单、全局变量等类型定义
  - 添加了配置选项和文件类型定义
  - 更新了Store以支持新的数据模型

- [x] **任务 1.4: 平台服务层接口实现 (Preload Script)**
  - 实现了readFile, writeFile, showOpenDialog等文件操作函数
  - 实现了parseYaml, serializeYaml等YAML处理函数
  - 实现了getEspansoConfigDir, getEspansoConfigFiles等Espanso相关函数
  - 确保js-yaml在preload环境中可用
  - 更新了Store中的loadConfig和saveConfig方法，使用新的fileService

- [x] **任务 2.1: Pinia Store 初始化与基础状态/Getter**
  - 完善了Store的状态管理、Getters和Actions
  - 实现了状态历史记录管理，支持撤销/重做功能
  - 添加了统一的addItem和updateItem方法
  - 实现了批量操作功能（批量添加、删除和更新）
  - 添加了导入/导出配置功能
  - 增强了搜索和过滤能力
  - 添加了更丰富的错误处理和恢复机制

- [x] **任务 2.2: UI 布局骨架搭建**
  - 已创建并美化了LeftPane, MiddlePane, RightPane组件
  - 实现了左侧菜单折叠功能
  - 实现了标签过滤功能
  - 添加了搜索功能
  - 优化了项目列表和详情页的显示

- [x] **任务 2.3: 规则和分组编辑表单组件**
  - 创建了RuleEditForm和GroupEditForm组件
  - 实现了表单验证和数据绑定
  - 添加了表单输入控件和样式
  - 添加了保存、取消、删除按钮
  - 实现了表单状态与属性同步
  - 支持了不同类型的输入字段

- [x] **任务 2.4: 加载/保存 Actions (连接 Preload)**
  - 已完善loadConfig和saveConfig Actions
  - 已实现与preload脚本的连接

- [x] **任务 3.1: ESPANSO 工具函数 (YAML 处理占位)**
  - 已实现parseYaml, serializeYaml等函数
  - 已实现convertToInternalFormat和convertToEspansoFormat函数

- [x] **临时任务 1: UI美化与现代化**
  - 更新了全局样式，使用现代化的设计变量（颜色、间距、阴影等）
  - 改进了三栏式布局组件的样式，添加了卡片式设计
  - 美化了表单和按钮样式
  - 添加了现代化的UI元素（徽章、卡片、加载状态等）
  - 优化了空状态和错误状态的显示
  - 添加了过渡效果和交互反馈

- [x] **临时任务 2: 修复和改进**
  - 修复了类型定义文件名的拼写错误（espanzo-config.ts → espanso-config.ts）
  - 在Store中使用导入的uuidv4函数代替crypto.randomUUID()
  - 在preload脚本中添加降级方案，以便在非Electron环境中也能正常工作
  - 更新了todo.md，调整了任务状态

- [x] **临时任务 3: 解决Electron应用的标题和白屏问题**
  - 优化了main.js主进程代码，增加多重错误处理和日志输出
  - 修复了index.html加载路径问题，通过动态路径查找确保正确加载
  - 添加了资源路径修复功能，将绝对路径(/assets/)转换为相对路径(./assets/)
  - 增强了打包脚本，添加更详细的文件存在性检查和内容目录列表
  - 实现了友好的错误页面，在加载失败时提供明确的错误信息和可能的解决方案
  - 禁用了asar打包，避免了资源访问问题
  - 增加了备用路径加载机制，确保在不同环境下都能找到正确的入口文件

- [x] **临时任务 4: Web端配置文件夹选择功能**
  - 添加了环境检测功能，区分电子端、uTools端和Web端
  - 实现了Web端手动选择配置文件夹功能
  - 添加了配置文件夹本地存储功能，保存用户选择
  - 优化了加载状态和错误处理
  - 添加了用户友好的配置选择界面
  - 支持在Web环境下手动浏览和选择文件系统

- [x] **临时任务 5: 更新项目文档**
  - 更新了README.md文件，添加了详细的项目说明
  - 完善了安装和使用说明，确保所有命令正确无误
  - 添加了项目结构说明，便于新开发者理解
  - 添加了故障排除和常见问题解答部分
  - 补充了特性说明和各环境下的使用差异
  - 改进了文档格式和排版，提高可读性

- [x] **任务 5.1: YAML 解析与序列化工具函数完善**
  - 已完善convertToInternalFormat和convertToEspansoFormat函数
  - 已实现对Espanso所有功能的支持

- [x] **任务 6.1: 导入/导出功能实现**
  - 已实现配置文件的导入和导出功能
  - 添加了importConfig和exportConfig方法
  - 实现了文件选择对话框集成
  - 添加了导入/导出过程中的错误处理
  - 支持多种文件格式（YAML）

- [x] **任务 7.1: 跨平台打包支持 (Electron)**
  - 创建了Electron主进程和预加载脚本
  - 实现了Electron打包和构建配置
  - 解决了打包时的路径问题和入口文件配置
  - 实现了基于fs模块的文件操作函数
  - 添加了开发环境和生产环境的切换逻辑
  - 解决了白屏问题和资源加载错误

- [x] **任务 7.2: uTools插件支持**
  - 创建了uTools插件配置文件
  - 实现了uTools预加载脚本
  - 添加了uTools插件打包脚本
  - 确保在uTools环境中正常加载应用

## 待完成功能

### 🚨 紧急优先级（系统稳定性与架构问题）

- [ ] **平台逻辑分离与重构**
  - 重构`fileService.ts`移除混合环境判断逻辑
  - 设计并实现平台适配器工厂模式
  - 确保Web和Electron环境有独立的、完整的代码路径
  - 移除`detectEnvironment()`函数
  
- [ ] **层级化数据结构实现**
  - 设计`FileSystemNode`接口支持目录-文件-规则层级结构
  - 修改`EspansoConfig`使其适合表示层级数据
  - 更新序列化与反序列化逻辑
  
- [ ] **Electron端自动加载默认配置**
  - 实现根据操作系统自动检测Espanso配置路径
  - 添加目录扫描功能，构建层级结构
  - 应用启动时自动加载配置

- [ ] **Web端上传逻辑修复**
  - 解决上传文件后无限加载的问题
  - 完善异步文件读取逻辑和错误处理
  - 优化上传界面，支持多文件和拖放

- [ ] **UI层级适配**
  - 设计递归组件用于渲染树状结构
  - 实现折叠/展开功能，文件夹/文件/规则视觉区分
  - 适配搜索和过滤功能，支持层级结构

### 高优先级

- [ ] **紧急任务 8.1: 平台逻辑分离与重构**
  - 在fileService和preload脚本中清晰分离Electron和Web环境逻辑
  - 重构Preload API设计，明确职责边界
  - 确保Web端和Electron端有各自独立且完整的实现路径
  - 移除平台判断中的冗余逻辑，采用策略模式设计
  
- [ ] **紧急任务 8.2: 层级化数据结构实现**
  - 设计并实现FileSystemNode接口，支持目录-文件-规则的层级结构
  - 修改EspansoConfig数据结构，支持树状结构
  - 更新Store中的状态管理逻辑，适配新的数据结构
  - 重构CRUD操作，支持层级化数据的增删改查

- [ ] **紧急任务 8.3: Electron端自动加载默认配置**
  - 实现getEspansoConfigPath() Preload API，自动检测平台并返回默认配置路径
  - 实现scanDirectory() Preload API，扫描目录结构并返回层级化的文件结构
  - 实现loadElectronConfig Store Action，启动时自动加载Espanso配置
  - 将配置文件夹名作为一级分组，文件名作为二级分组，规则作为叶子节点

- [ ] **紧急任务 8.4: Web端上传逻辑修复**
  - 修复Web端上传文件后无限加载的问题
  - 实现文件内容解析与层级结构构建的分离
  - 添加加载状态的错误处理和恢复机制
  - 优化文件上传界面，支持多文件选择和拖放功能

- [ ] **紧急任务 8.5: UI层级适配**
  - 重构MiddlePane组件，支持展示层级化的配置结构
  - 实现递归组件设计，用于渲染树状结构
  - 添加展开/折叠功能，使层级结构易于浏览
  - 更新过滤和搜索功能，支持在树状结构中查找

- [ ] **临时任务 6: UI 简化与优化**
  - 移除 header 部分，将标题直接显示在左边栏最上方
  - 优化布局结构，使界面更加简洁
  - 确保标题样式与整体设计风格一致
  - 调整左侧栏的间距和布局以适应新的标题位置

- [ ] **临时任务 7: 自动保存功能实现**
  - 移除手动保存和打开配置按钮
  - 实现配置文件的自动保存功能
    - 监听分组信息更新
    - 监听片段信息更新
    - 在数据变更时自动保存到本地文件
  - 优化首次使用体验
    - 如果没有配置文件，直接显示文件选择界面
    - 设计友好的文件选择提示界面
    - 保存用户选择的配置文件路径
  - 添加自动保存状态提示（如保存中、保存成功等）

- [ ] **任务 3.2: ESPANSO 工具函数 (增删改)**
  - 需要实现removeItemById等工具函数
  - 需要实现insertItemAtIndex等工具函数
  - 确保函数返回新的根节点对象以维持响应性

- [ ] **任务 3.3: Pinia Store CRUD Actions 实现**
  - 需要完善addItem、updateItem、deleteItem等Actions
  - 需要确保Actions能正确调用工具函数
  - 需要更新Store状态并保持响应性

- [ ] **任务 3.6: 右侧面板逻辑 (连接 Store 与表单)**
  - 需要在RightPane中连接Store和表单组件
  - 需要根据选中项类型渲染不同的表单
  - 需要处理表单操作并调用Store Actions

- [ ] **任务 4.1: 拖拽排序功能 (UI & Action 调用)**
  - 需要集成vue-draggable-next
  - 需要实现拖拽事件处理
  - 需要实现moveItem Action并更新Store状态

- [ ] **任务 4.2: 规则表单 - 高级字段 (纯 UI)**
  - 需要实现应用限制、标签等高级字段
  - 需要创建TagInput组件
  - 需要实现内容类型切换功能

- [ ] **任务 4.3: 规则表单 - 高级内容编辑器 (UI 集成)**
  - 需要实现不同contentType的编辑器
  - 需要集成富文本、代码、图片等编辑组件
  - 需要实现内容与表单状态同步

- [ ] **任务 4.4: 规则表单 - 插入变量与预览**
  - 需要完善generatePreview函数
  - 需要实现变量插入功能
  - 需要显示规则预览效果

- [ ] **任务 4.5: 规则列表树状分组展示**
  - 需要实现分组的折叠/展开功能
  - 需要使用树形结构显示规则，清晰展示父子关系
  - 需要支持分组内规则的嵌套显示
  - 需要添加视觉提示，识别规则和分组的层次关系
  - 需要实现分组的计数统计（显示每个分组内的规则数量）

- [ ] **任务 4.6: 标签管理功能实现**
  - 需要实现标签的添加、删除和过滤功能
  - 需要实现标签云组件
  - 需要支持通过标签筛选规则

- [ ] **任务 6.2: 应用限制功能实现**
  - 需要实现应用限制（apps）功能
  - 需要支持应用列表管理
  - 需要支持排除应用列表

- [ ] **任务 6.3: 错误处理与用户通知**
  - 需要完善错误处理和用户通知功能
  - 需要实现全局错误捕获
  - 需要提供友好的错误提示

- [ ] **任务 6.4: 最终测试与代码审查**
  - 需要进行全面测试和代码审查
  - 需要修复潜在问题和改进用户体验
  - 需要优化性能和稳定性

- [ ] **任务 7.3: 应用图标和品牌设计**
  - 需要设计应用图标和品牌元素
  - 需要为不同平台创建适配的图标尺寸
  - 需要更新打包配置以使用自定义图标

- [ ] **任务 7.4: 安装包和发布配置**
  - 需要配置electron-builder以创建安装包
  - 需要为各平台（Windows/macOS/Linux）优化打包设置
  - 需要创建自动发布流程
